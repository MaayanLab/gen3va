{% extends 'wrapper.html' %}

{% block title %}{{ tag.name }}{% endblock %}

{% block body %}

    <script src="static/lib/highcharts/highcharts.js"></script>
    <script src="static/lib/highcharts/highcharts-3d.js"></script>
    <script src="static/lib/highcharts/highcharts-exporting.js"></script>

    <link href="https://cdn.datatables.net/1.10.10/css/dataTables.bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.10/js/dataTables.bootstrap.min.js"></script>

    <script src="static/js/report.js"></script>

    <div class="page" id="report-page">

        <div class="report-metadata">
            <h1><strong>{{ tag.name }}</strong> <span>report</span></h1>
            {% if report.tag.description %}
                <p>{{ report.tag.description }}</p>
            {% endif %}
        </div>

        <!-- Gene signatures -->
        <div id="gene-signatures-table" class="section">
            <h4>Gene signatures</h4>
            <p>
                <a href="{{ tag.name|c_tag_url }}">{{ report.gene_signatures|length }} processed gene signatures</a>
            </p>
            <p class="download-link">
                <a href="{{ report.id|c_download_url }}" target="_blank">Download genes signatures as TSV</a>
            </p>
            <div class="table-responsive">
                <table class="table data-table responsive">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Results</th>
                            <th>Title</th>
                            <th>Organism</th>
                            <th>Platform</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for gene_signature in report.gene_signatures %}
                            {% set dataset = gene_signature.soft_file.dataset %}
                            <tr>
                                <td class="index">{{ loop.index }}</td>
                                <td class="results" >
                                    <a href="{{ gene_signature.extraction_id|c_results_url }}" target="_blank">
                                        <i class="fa fa-file-o" data-toggle="tooltip" title="Results page for the processed gene signature."></i>
                                    </a>
                                </td>
                                <td class="title">
                                    {{ dataset.title|c_filter_empty|truncate(150) }}
                                </td>
                                <td class="organism">
                                    {{ dataset.organism|c_filter_empty }}
                                </td>
                                <td class="platform">{{ dataset.platform|c_filter_empty }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Principal Component Analysis -->
        {% if pca_json %}
            <div class="section">
                <h4>PCA</h4>
                <p>Interactive 3D principal component analysis of gene signatures. You can rotate the visualization and mouse over the data points.</p>
                <div id="pca-container"></div>
            </div>
            <script>
                $(function () {
                    plotPCA({{ pca_json|safe }});
                });
            </script>
        {% endif %}

        <!-- Genes hierarchical clusterings -->
        {% if report.genes_hier_clust %}
            <div class="section">
                <h4>Genes</h4>
                <p>Hierarchical clustering of genes based on weights from differential expression method.</p>
                <iframe src="{{ report.genes_hier_clust.link }}"></iframe>
            </div>
        {% endif %}

        <!-- Enrichr hierarchical clusterings -->
        {% if report.enrichr_hier_clusts|length > 0 %}
            <div id="enrichr-hier-clusts" class="section">
                <h4>Enrichr</h4>
                <div class="description">
                    <span>Hierarchical clustering of enriched terms from</span>
                    <select>
                        {% for library in enrichr_libraries %}
                            <option>{{ library }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% for clust in report.enrichr_hier_clusts %}
                    <iframe src="{{ clust.link }}" data-enrichr-library="{{ clust.enrichr_library }}"></iframe>
                {% endfor %}
            </div>
        {% endif %}

        <!-- L1000CD2 hierarchical clusterings -->
        {% if report.l1000cds2_hier_clust %}
            <div class="section">
                <h4>L1000CDS2</h4>
                <p>Hierarchical clustering of perturbations that mimic (red) and reverse (blue) expression</p>
                <iframe src="{{ report.l1000cds2_hier_clust.link }}"></iframe>
            </div>
        {% endif %}
    </div>

{% endblock %}